<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ambient Synths Final with Loop Control</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
  <style>
    body {
      background-color: #f4f1e8;
      font-family: sans-serif;
      color: #333;
      text-align: center;
      padding: 20px;
    }
    h1 { color: #699bc8; }
    .slider-group, .synth-box { margin: 20px auto; }
    .sprite {
      font-size: 40px;
      display: inline-block;
      transition: transform 0.1s ease;
    }
    .sprite.active {
      transform: scale(1.2) rotate(10deg);
    }
    .synth-box {
      border: 2px solid #8ea47d;
      border-radius: 10px;
      padding: 10px;
      width: 90%;
      max-width: 500px;
      background: #fff;
    }
    button {
      background: #e6695a;
      color: white;
      padding: 10px 20px;
      margin: 10px;
      border: none;
      cursor: pointer;
    }
    button.active { background: #699bc8; }
  </style>
</head>
<body>
  <h1>Ambient Synths + Smart Loop Control</h1>

  <div class="slider-group">
    <label>ESP32 #1 Temp: <span id="temp1">25</span>°C</label><br/>
    <input type="range" min="10" max="40" value="25" id="slider1" />
  </div>
  <div class="slider-group">
    <label>ESP32 #2 Temp: <span id="temp2">25</span>°C</label><br/>
    <input type="range" min="10" max="40" value="25" id="slider2" />
  </div>
  <div class="slider-group">
    <label>ESP32 #3 Temp: <span id="temp3">25</span>°C</label><br/>
    <input type="range" min="10" max="40" value="25" id="slider3" />
  </div>

  <button id="modeBtn">Mode: Auto</button>
  <button id="micBtn">🎤 Tap to Record Rhythm (5s)</button>
  <button id="stopBtn">🛑 Emergency Stop</button>
  <p id="status">Idle</p>

  <div class="synth-box" id="synth1">
    <h3>Gamelan Synth</h3>
    <div class="sprite" id="sprite1">🦑</div>
  </div>
  <div class="synth-box" id="synth2">
    <h3>FM Synth</h3>
    <div class="sprite" id="sprite2">🦑</div>
  </div>
  <div class="synth-box" id="synth3">
    <h3>Sampler Synth</h3>
    <div class="sprite" id="sprite3">🦑</div>
  </div>

  <script>
    const sliders = [slider1, slider2, slider3];
    const temps = [temp1, temp2, temp3];
    sliders.forEach((s, i) => s.oninput = () => temps[i].textContent = s.value);

    const sprites = [sprite1, sprite2, sprite3];
    const modeBtn = document.getElementById("modeBtn");
    const micBtn = document.getElementById("micBtn");
    const stopBtn = document.getElementById("stopBtn");
    const status = document.getElementById("status");

    let mode = "auto";
    let rhythmLoop;
    let savedRhythm = [];

    modeBtn.onclick = () => {
      mode = mode === "auto" ? "song" : "auto";
      modeBtn.textContent = `Mode: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`;
      if (rhythmLoop) rhythmLoop.stop();
    };

    stopBtn.onclick = () => {
      if (rhythmLoop) rhythmLoop.stop();
      Tone.Transport.cancel();
      status.textContent = "⛔ Loop stopped manually.";
    };

    const gamelanScale = ["C4", "D4", "F4", "G4", "Bb4", "C5"];
    const reverb = new Tone.Reverb({ decay: 8, wet: 0.7 }).toDestination();
    reverb.generate();

    const synths = [
      new Tone.MembraneSynth({ pitchDecay: 0.1, octaves: 3 }).connect(reverb),
      new Tone.FMSynth().connect(reverb),
      new Tone.Sampler({
        urls: { C3: "C3.mp3" },
        baseUrl: "https://tonejs.github.io/audio/salamander/"
      }).connect(reverb),
    ];

    function triggerSynth(i, note = null) {
      const n = note || gamelanScale[Math.floor(Math.random() * gamelanScale.length)];
      synths[i].triggerAttackRelease(n, "8n");
      sprites[i].classList.add("active");
      setTimeout(() => sprites[i].classList.remove("active"), 120);
    }

    function allTempsValid() {
      return sliders.every(s => parseInt(s.value) >= 20 && parseInt(s.value) <= 35);
    }

    function checkTemps() {
      sliders.forEach((slider, i) => {
        const temp = parseInt(slider.value);
        if (temp >= 20 && temp <= 35) {
          sprites[i].style.visibility = "visible";
          if (mode === "auto") triggerSynth(i);
        } else {
          sprites[i].style.visibility = "hidden";
        }
      });

      if (mode === "song") {
        if (allTempsValid()) {
          if (savedRhythm.length && (!rhythmLoop || !rhythmLoop.state === "started")) {
            setupRhythmLoop(savedRhythm);
          }
        } else {
          if (rhythmLoop) rhythmLoop.stop();
        }
      }
    }

    let mic, meter;
    async function setupMic() {
      if (!mic) {
        mic = new Tone.UserMedia();
        meter = new Tone.Meter({ channels: 1 });
        await mic.open();
        mic.connect(meter);
      }
    }

    function detectRhythm(duration = 5000) {
      const rhythmTimes = [];
      let last = 0;
      const start = performance.now();
      const threshold = -50;

      const loop = setInterval(() => {
        const now = performance.now();
        const db = meter.getValue();
        if (db > threshold && now - last > 150) {
          last = now;
          rhythmTimes.push((now - start) / 1000);
        }
        if (now - start > duration) {
          clearInterval(loop);
          status.textContent = `🎶 Detected ${rhythmTimes.length} pulses.`;
          micBtn.disabled = false;
          micBtn.textContent = "🎤 Tap to Record Rhythm (5s)";
          savedRhythm = rhythmTimes;
          if (mode === "song" && allTempsValid()) {
            setupRhythmLoop(savedRhythm);
          } else {
            playOnce(rhythmTimes);
          }
        }
      }, 40);
    }

    function playOnce(times) {
      const baseTime = Tone.now();
      times.forEach(t => {
        Tone.Transport.scheduleOnce(() => {
          for (let i = 0; i < 3; i++) triggerSynth(i);
        }, baseTime + t);
      });
      Tone.Transport.start();
    }

    function setupRhythmLoop(times) {
      if (rhythmLoop) rhythmLoop.dispose();
      rhythmLoop = new Tone.Part((time) => {
        for (let i = 0; i < 3; i++) triggerSynth(i);
      }, times.map(t => [t, null]));
      rhythmLoop.loop = true;
      rhythmLoop.loopEnd = times[times.length - 1] + 0.5;
      rhythmLoop.start(0);
      Tone.Transport.start();
    }

    micBtn.onclick = async () => {
      await Tone.start();
      micBtn.disabled = true;
      micBtn.textContent = "Recording... (5s)";
      status.textContent = "🎙️ Listening for rhythm...";
      await setupMic();
      detectRhythm(5000);
    };

    Tone.Transport.scheduleRepeat(() => {
      checkTemps();
    }, "1s");

    Tone.start().then(() => Tone.Transport.start());
  </script>
</body>
</html>
