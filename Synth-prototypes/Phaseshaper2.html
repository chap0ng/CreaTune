<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiral Ambient Phaseshaper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f5f1e6;
            font-family: sans-serif;
            color: #3a3226;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        canvas {
            background: #e8e0d0;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
            max-width: 600px;
        }
        button {
            background: #a68a64;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #8a6d48;
        }
        h1 {
            color: #5d4b36;
            margin-bottom: 10px;
        }
        p {
            color: #7a6b58;
            margin-top: 0;
        }
        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }
        label {
            font-size: 12px;
            margin-bottom: 4px;
            color: #5d4b36;
        }
        input[type="range"] {
            width: 100%;
            accent-color: #a68a64;
        }
        .control-group {
            background: rgba(166, 138, 100, 0.1);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(166, 138, 100, 0.2);
        }
        .control-group h3 {
            margin: 0 0 8px 0;
            color: #5d4b36;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Chiral Ambient Phaseshaper</h1>
    <p>Generative phaseshaping with Valhalla-style reverb</p>
    
    <div class="controls">
        <div class="control-group">
            <h3>Transport</h3>
            <button id="start">Start</button>
            <button id="stop">Stop</button>
        </div>
        
        <div class="control-group">
            <h3>Phaseshaping</h3>
            <div class="slider-container">
                <label for="phaseDepth">Depth</label>
                <input type="range" id="phaseDepth" min="0" max="100" value="50">
            </div>
            <div class="slider-container">
                <label for="phaseRate">Rate</label>
                <input type="range" id="phaseRate" min="0" max="2" step="0.1" value="0.5">
            </div>
        </div>
        
        <div class="control-group">
            <h3>Reverb</h3>
            <div class="slider-container">
                <label for="reverbMix">Mix</label>
                <input type="range" id="reverbMix" min="0" max="1" step="0.01" value="0.8">
            </div>
            <div class="slider-container">
                <label for="reverbDecay">Decay</label>
                <input type="range" id="reverbDecay" min="0.1" max="10" step="0.1" value="3.5">
            </div>
        </div>
        
        <div class="control-group">
            <h3>Pattern</h3>
            <div class="slider-container">
                <label for="noteLength">Note Length</label>
                <input type="range" id="noteLength" min="0.1" max="2" step="0.1" value="0.8">
            </div>
            <div class="slider-container">
                <label for="randomness">Randomness</label>
                <input type="range" id="randomness" min="0" max="100" value="60">
            </div>
        </div>
    </div>
    
    <canvas id="scope" width="500" height="350"></canvas>
    
    <script>
        // Extended C Major scale notes (more octaves, some chromatic neighbors)
        const cMajor = [
            "C3", "D3", "E3", "F3", "G3", "A3", "B3", 
            "C4", "D4", "E4", "F4", "G4", "A4", "B4", 
            "C5", "D5", "E5", "F5", "G5", "A5", "B5",
            "C#3", "D#3", "F#3", "G#3", "A#3",
            "C#4", "D#4", "F#4", "G#4", "A#4",
            "C#5", "D#5", "F#5", "G#5", "A#5"
        ];
        
        // Setup Tone.js
        const synth = new Tone.PolySynth(Tone.Synth, {
            oscillator: {
                type: "sine",
                partialCount: 0,
                phase: 0
            },
            envelope: {
                attack: 0.05,
                decay: 0.2,
                sustain: 0.3,
                release: 0.8
            }
        }).toDestination();
        
        // Valhalla-style reverb
        const reverb = new Tone.Reverb({
            decay: 3.5,
            wet: 0.8,
            preDelay: 0.1
        }).toDestination();
        
        // Phaseshaping effect
        const phaseShift = new Tone.Phaser({
            frequency: 0.5,
            octaves: 2,
            baseFrequency: 200,
            Q: 10,
            wet: 0.7
        });
        
        // Delay for more ambient texture
        const delay = new Tone.PingPongDelay({
            delayTime: "6n",
            feedback: 0.7,
            wet: 0.5,
        });
        
        // Effects chain
        synth.chain(phaseShift, delay, reverb);
        
        // Generative pattern with more randomness
        const pattern = new Tone.Pattern((time, note) => {
            const randomness = parseFloat(document.getElementById("randomness").value) / 100;
            const noteLength = parseFloat(document.getElementById("noteLength").value);
            
            // Random chance to play note based on randomness control
            if (Math.random() > (0.3 * randomness)) {
                // Randomize velocity for more expression
                const velocity = 0.5 + Math.random() * 0.5;
                
                // Modulate phase for the twisting effect
                const phaseDepth = document.getElementById("phaseDepth").value / 100;
                const phaseRate = parseFloat(document.getElementById("phaseRate").value);
                const phase = Math.sin(time * phaseRate) * Math.PI * phaseDepth;
                synth.set({ oscillator: { phase } });
                
                // Randomize phaser for more movement
                phaseShift.frequency.value = 0.3 + Math.random() * 0.7;
                
                // Sometimes play 2 notes at once for richer texture
                if (Math.random() < 0.3 * randomness) {
                    const secondNote = cMajor[Math.floor(Math.random() * cMajor.length)];
                    const interval = Math.random() < 0.5 ? 3 : 5; // 3rds or 5ths
                    synth.triggerAttackRelease([note, secondNote], noteLength, time, velocity);
                } else {
                    synth.triggerAttackRelease(note, noteLength, time, velocity);
                }
            }
            
        }, cMajor, "randomWalk").start(0);
        
        // Set tempo slower for ambient feel
        Tone.Transport.bpm.value = 60;
        
        // 3D oscilloscope visualization
        const canvas = document.getElementById("scope");
        const ctx = canvas.getContext("2d");
        
        const analyser = new Tone.Analyser("waveform", 1024);
        synth.connect(analyser);
        
        let animationId;
        
        function drawScope() {
            animationId = requestAnimationFrame(drawScope);
            
            const width = canvas.width;
            const height = canvas.height;
            const waveform = analyser.getValue();
            
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = "#f5f1e6";
            ctx.fillRect(0, 0, width, height);
            
            // Draw the twisted waveform
            ctx.beginPath();
            ctx.strokeStyle = "#8a6d48";
            ctx.lineWidth = 2;
            
            const phaseDepth = document.getElementById("phaseDepth").value / 50;
            const phaseRate = parseFloat(document.getElementById("phaseRate").value);
            
            for (let i = 0; i < waveform.length; i++) {
                const x = (i / waveform.length) * width;
                
                // Create twisting effect by combining waveform with phase modulation
                const twist = Math.sin(i * 0.1 * phaseRate + Date.now() * 0.001) * 50 * phaseDepth;
                const y = (0.5 + waveform[i] / 2) * height + twist;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
            
            // Add holographic effect lines
            ctx.beginPath();
            ctx.strokeStyle = "rgba(166, 138, 100, 0.3)";
            ctx.lineWidth = 1;
            
            for (let i = 0; i < waveform.length; i += 10) {
                const x = (i / waveform.length) * width;
                const twist = Math.sin(i * 0.1 * phaseRate + Date.now() * 0.001) * 50 * phaseDepth;
                const y = (0.5 + waveform[i] / 2) * height + twist;
                
                ctx.moveTo(x, height/2);
                ctx.lineTo(x, y);
            }
            
            ctx.stroke();
        }
        
        // UI controls
        document.getElementById("start").addEventListener("click", async () => {
            await Tone.start();
            Tone.Transport.start();
            drawScope();
        });
        
        document.getElementById("stop").addEventListener("click", () => {
            Tone.Transport.stop();
            cancelAnimationFrame(animationId);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
        
        // Control bindings
        document.getElementById("reverbMix").addEventListener("input", (e) => {
            reverb.wet.value = parseFloat(e.target.value);
        });
        
        document.getElementById("reverbDecay").addEventListener("input", (e) => {
            reverb.decay = parseFloat(e.target.value);
        });
        
        document.getElementById("phaseDepth").addEventListener("input", (e) => {
            // No need to do anything here - value is read in drawScope and pattern callback
        });
        
        document.getElementById("phaseRate").addEventListener("input", (e) => {
            // No need to do anything here - value is read in drawScope and pattern callback
        });
        
        document.getElementById("noteLength").addEventListener("input", (e) => {
            // No need to do anything here - value is read in pattern callback
        });
        
        document.getElementById("randomness").addEventListener("input", (e) => {
            // No need to do anything here - value is read in pattern callback
        });
    </script>
</body>
</html>