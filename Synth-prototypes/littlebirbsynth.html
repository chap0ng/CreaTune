<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bïrb Synth</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #e6dfd2;
      font-family: 'Courier New', monospace;
      color: #5a4e3e;
      overflow: hidden;
      touch-action: none;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
    }
    
    .title {
      font-size: 24px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 3px;
    }
    
    .power-button {
      width: 60px;
      height: 30px;
      background: #94836f;
      border-radius: 15px;
      display: flex;
      align-items: center;
      padding: 0 5px;
      cursor: pointer;
      position: relative;
    }
    
    .power-button::after {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      background: #e6dfd2;
      border-radius: 50%;
      left: 5px;
      transition: transform 0.3s;
    }
    
    .power-button.on::after {
      transform: translateX(26px);
    }
    
    .synth-display {
      flex: 1;
      background: #c4baa9;
      border-radius: 10px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      position: relative;
      margin-bottom: 20px;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .birb-container {
      position: relative;
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .control-group {
      background: #d8cebb;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .control-title {
      font-size: 12px;
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }
    
    .knob-container {
      display: flex;
      justify-content: space-around;
    }
    
    .knob {
      position: relative;
      width: 60px;
      height: 60px;
      background: #a69885;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), inset 0 -3px 6px rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }
    
    .knob::after {
      content: '';
      position: absolute;
      width: 3px;
      height: 20px;
      background: #e6dfd2;
      top: 10px;
      transform-origin: bottom center;
    }
    
    .knob-label {
      font-size: 10px;
      text-align: center;
      margin-top: 5px;
    }
    
    .keys {
      display: flex;
      gap: 8px;
      height: 120px;
    }
    
    .key {
      flex: 1;
      background: #e6dfd2;
      border-radius: 0 0 5px 5px;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 10px;
      cursor: pointer;
      box-shadow: 0 4px 0 #a69885;
      transition: transform 0.1s;
      user-select: none;
    }
    
    .key.active {
      background: #b9af9c;
      transform: translateY(4px);
      box-shadow: 0 0 0 #a69885;
    }
    
    .waveform-selector {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
    }
    
    .wave-button {
      padding: 5px 10px;
      background: #a69885;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .wave-button.active {
      background: #7a6e5d;
      color: #e6dfd2;
    }
    
    .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(163, 148, 123, 0.3);
      transform: scale(0);
      animation: ripple 1s linear;
      pointer-events: none;
    }
    
    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }
    
    .birb {
      width: 100px;
      height: 100px;
      position: absolute;
      transition: transform 0.3s ease-out;
    }
    
    .birb-body {
      width: 60px;
      height: 60px;
      background: #8f7e69;
      border-radius: 50%;
      position: relative;
    }
    
    .birb-eye {
      width: 12px;
      height: 12px;
      background: #e6dfd2;
      border-radius: 50%;
      position: absolute;
      top: 15px;
      left: 15px;
    }
    
    .birb-eye::after {
      content: '';
      width: 6px;
      height: 6px;
      background: #000;
      border-radius: 50%;
      position: absolute;
      top: 3px;
      left: 3px;
    }
    
    .birb-beak {
      width: 15px;
      height: 10px;
      background: #c9936b;
      position: absolute;
      top: 25px;
      left: -5px;
      clip-path: polygon(0 50%, 100% 0, 100% 100%);
    }
    
    .birb-wing {
      width: 30px;
      height: 40px;
      background: #7a6e5d;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      position: absolute;
      top: 20px;
      right: -10px;
      transform-origin: 0 50%;
    }
    
    .birb-wing.flap {
      animation: flap 0.3s ease-in-out;
    }
    
    @keyframes flap {
      0%, 100% { transform: rotate(0deg); }
      50% { transform: rotate(-30deg); }
    }
    
    .birb-feet {
      width: 10px;
      height: 15px;
      background: #c9936b;
      position: absolute;
      bottom: -10px;
      left: 25px;
      clip-path: polygon(0 0, 35% 0, 35% 50%, 65% 50%, 65% 0, 100% 0, 100% 50%, 0 50%);
    }
    
    .visualizer {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      height: 30px;
      background: rgba(118, 109, 94, 0.2);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .visualizer-bars {
      display: flex;
      height: 100%;
      align-items: flex-end;
      gap: 2px;
      padding: 0 2px;
    }
    
    .visualizer-bar {
      flex: 1;
      background: #8f7e69;
      height: 5%;
      transition: height 0.05s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Bïrb Synth</div>
      <div class="power-button" id="power"></div>
    </div>
    
    <div class="synth-display">
      <div class="birb-container">
        <div class="birb" id="birb">
          <div class="birb-body">
            <div class="birb-eye"></div>
            <div class="birb-beak"></div>
            <div class="birb-wing" id="birb-wing"></div>
            <div class="birb-feet"></div>
          </div>
        </div>
      </div>
      
      <div class="visualizer">
        <div class="visualizer-bars" id="visualizer"></div>
      </div>
    </div>
    
    <div class="controls">
      <div class="control-group">
        <div class="control-title">Oscillator</div>
        <div class="waveform-selector">
          <div class="wave-button active" data-wave="sine">Sine</div>
          <div class="wave-button" data-wave="triangle">Tri</div>
          <div class="wave-button" data-wave="sawtooth">Saw</div>
          <div class="wave-button" data-wave="square">Sqr</div>
        </div>
        <div class="knob-container">
          <div>
            <div class="knob" id="detune-knob" data-min="-50" data-max="50" data-value="0"></div>
            <div class="knob-label">Detune</div>
          </div>
          <div>
            <div class="knob" id="glide-knob" data-min="0" data-max="1" data-value="0.1"></div>
            <div class="knob-label">Glide</div>
          </div>
        </div>
      </div>
      
      <div class="control-group">
        <div class="control-title">Effects</div>
        <div class="knob-container">
          <div>
            <div class="knob" id="reverb-knob" data-min="0" data-max="1" data-value="0.3"></div>
            <div class="knob-label">Reverb</div>
          </div>
          <div>
            <div class="knob" id="delay-knob" data-min="0" data-max="0.7" data-value="0"></div>
            <div class="knob-label">Delay</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="keys" id="keyboard">
      <div class="key" data-note="C4">C</div>
      <div class="key" data-note="D4">D</div>
      <div class="key" data-note="E4">E</div>
      <div class="key" data-note="F4">F</div>
      <div class="key" data-note="G4">G</div>
      <div class="key" data-note="A4">A</div>
      <div class="key" data-note="B4">B</div>
      <div class="key" data-note="C5">C</div>
    </div>
  </div>

  <script>
    // Create visualizer bars
    const visualizer = document.getElementById('visualizer');
    for (let i = 0; i < 16; i++) {
      const bar = document.createElement('div');
      bar.className = 'visualizer-bar';
      visualizer.appendChild(bar);
    }
    
    // Initialize Tone.js synth and effects
    let synthInitialized = false;
    let synth, filter, reverb, delay, analyser;
    let isPlaying = false;
    let currentOctave = 4;
    let waveform = 'sine';
    let powerOn = false;
    
    // Initialize bird position variables
    let birbX = 0;
    let birbY = 0;
    let birbTargetX = 0;
    let birbTargetY = 0;
    
    const powerButton = document.getElementById('power');
    const birbElement = document.getElementById('birb');
    const birbWing = document.getElementById('birb-wing');
    const keys = document.querySelectorAll('.key');
    const waveButtons = document.querySelectorAll('.wave-button');
    const knobs = document.querySelectorAll('.knob');
    const container = document.querySelector('.container');
    const birbContainer = document.querySelector('.birb-container');
    
    // Setup initial bird position
    updateBirbPosition(birbContainer.clientWidth / 2, birbContainer.clientHeight / 2);
    
    // Function to initialize synth
    function initializeSynth() {
      // Create synth
      synth = new Tone.PolySynth(Tone.Synth, {
        oscillator: {
          type: waveform
        },
        envelope: {
          attack: 0.02,
          decay: 0.1,
          sustain: 0.3,
          release: 1
        }
      }).toDestination();
      
      // Create filter
      filter = new Tone.Filter({
        type: 'lowpass',
        frequency: 2000,
        Q: 1
      });
      
      // Create reverb with Valhalla-style settings
      reverb = new Tone.Reverb({
        decay: 4,
        preDelay: 0.01,
        wet: 0.3
      });
      
      // Create delay
      delay = new Tone.FeedbackDelay({
        delayTime: 0.3,
        feedback: 0.3,
        wet: 0
      });
      
      // Create analyzer for visualizer
      analyser = new Tone.Analyser('waveform', 32);
      
      // Connect everything
      synth.chain(filter, delay, reverb, analyser, Tone.Destination);
      
      // Mark synth as initialized
      synthInitialized = true;
    }
    
    // Create ripple effect
    function createRipple(x, y) {
      const ripple = document.createElement('div');
      ripple.className = 'ripple';
      ripple.style.left = x + 'px';
      ripple.style.top = y + 'px';
      container.appendChild(ripple);
      
      setTimeout(() => {
        ripple.remove();
      }, 1000);
    }
    
    // Bird animation
    function updateBirbPosition(x, y) {
      birbTargetX = x - 50;  // Center the bird
      birbTargetY = y - 50;
      
      // Apply easing to bird movement
      birbX += (birbTargetX - birbX) * 0.1;
      birbY += (birbTargetY - birbY) * 0.1;
      
      birbElement.style.transform = `translate(${birbX}px, ${birbY}px)`;
      
      if (powerOn) {
        requestAnimationFrame(() => updateBirbPosition(birbTargetX, birbTargetY));
      }
    }
    
    // Flap the bird's wing
    function flapWings() {
      birbWing.classList.add('flap');
      setTimeout(() => {
        birbWing.classList.remove('flap');
      }, 300);
    }
    
    // Update visualizer
    function updateVisualizer() {
      if (powerOn && synthInitialized) {
        const waveformData = analyser.getValue();
        const bars = document.querySelectorAll('.visualizer-bar');
        
        for (let i = 0; i < bars.length; i++) {
          const index = Math.floor(i * (waveformData.length / bars.length));
          const value = Math.abs(waveformData[index]);
          bars[i].style.height = Math.min(100, value * 200) + '%';
        }
        
        requestAnimationFrame(updateVisualizer);
      }
    }
    
    // Play a note
    function playNote(note) {
      if (!powerOn || !synthInitialized) return;
      
      synth.triggerAttack(note);
      isPlaying = true;
      
      // Animate bird
      birbTargetY -= 30;
      flapWings();
      
      // Move bird based on note
      const noteIndex = ['C', 'D', 'E', 'F', 'G', 'A', 'B'].indexOf(note[0]);
      if (noteIndex !== -1) {
        const containerWidth = birbContainer.clientWidth;
        birbTargetX = (containerWidth * noteIndex / 7) + containerWidth / 14;
      }
    }
    
    // Stop a note
    function stopNote(note) {
      if (!powerOn || !synthInitialized) return;
      synth.triggerRelease(note);
    }
    
    // Power button click handler
    powerButton.addEventListener('click', () => {
      powerOn = !powerOn;
      powerButton.classList.toggle('on');
      
      if (powerOn) {
        if (!synthInitialized) {
          // Initialize Tone.js
          Tone.start();
          initializeSynth();
        }
        
        // Start animations
        updateBirbPosition(birbContainer.clientWidth / 2, birbContainer.clientHeight / 2);
        updateVisualizer();
      } else {
        // Stop all sounds
        if (synthInitialized) {
          synth.releaseAll();
        }
      }
    });
    
    // Keyboard event handlers
    keys.forEach(key => {
      key.addEventListener('mousedown', (e) => {
        if (!powerOn) return;
        const note = key.dataset.note;
        key.classList.add('active');
        playNote(note);
        createRipple(e.offsetX + key.offsetLeft, e.offsetY + key.offsetTop);
      });
      
      key.addEventListener('mouseup', () => {
        if (!powerOn) return;
        const note = key.dataset.note;
        key.classList.remove('active');
        stopNote(note);
      });
      
      key.addEventListener('touchstart', (e) => {
        if (!powerOn) return;
        e.preventDefault();
        const note = key.dataset.note;
        key.classList.add('active');
        playNote(note);
        const touch = e.touches[0];
        const rect = key.getBoundingClientRect();
        createRipple(touch.clientX - rect.left, touch.clientY - rect.top);
      });
      
      key.addEventListener('touchend', (e) => {
        if (!powerOn) return;
        e.preventDefault();
        const note = key.dataset.note;
        key.classList.remove('active');
        stopNote(note);
      });
      
      // Prevent dragging on keys
      key.addEventListener('mouseout', () => {
        if (key.classList.contains('active')) {
          const note = key.dataset.note;
          key.classList.remove('active');
          stopNote(note);
        }
      });
    });
    
    // Wave button handlers
    waveButtons.forEach(button => {
      button.addEventListener('click', () => {
        if (!powerOn) return;
        
        waveButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        waveform = button.dataset.wave;
        if (synthInitialized) {
          synth.set({
            oscillator: {
              type: waveform
            }
          });
        }
      });
    });
    
    // Knob handling
    let activeKnob = null;
    let startY = 0;
    
    knobs.forEach(knob => {
      // Set initial rotation
      const value = parseFloat(knob.dataset.value);
      const min = parseFloat(knob.dataset.min);
      const max = parseFloat(knob.dataset.max);
      const angle = ((value - min) / (max - min)) * 270 - 135;
      knob.style.transform = `rotate(${angle}deg)`;
      
      knob.addEventListener('mousedown', function(e) {
        if (!powerOn) return;
        activeKnob = this;
        startY = e.clientY;
        document.addEventListener('mousemove', handleKnobDrag);
        document.addEventListener('mouseup', () => {
          activeKnob = null;
          document.removeEventListener('mousemove', handleKnobDrag);
        });
      });
      
      knob.addEventListener('touchstart', function(e) {
        if (!powerOn) return;
        e.preventDefault();
        activeKnob = this;
        startY = e.touches[0].clientY;
        document.addEventListener('touchmove', handleKnobTouchDrag);
        document.addEventListener('touchend', () => {
          activeKnob = null;
          document.removeEventListener('touchmove', handleKnobTouchDrag);
        });
      });
    });
    
    function handleKnobDrag(e) {
      if (!activeKnob) return;
      updateKnob(e.clientY - startY);
      startY = e.clientY;
    }
    
    function handleKnobTouchDrag(e) {
      if (!activeKnob) return;
      updateKnob(e.touches[0].clientY - startY);
      startY = e.touches[0].clientY;
    }
    
    function updateKnob(deltaY) {
      // Calculate knob value
      const min = parseFloat(activeKnob.dataset.min);
      const max = parseFloat(activeKnob.dataset.max);
      const range = max - min;
      const step = range / 100;
      
      // Get current value
      let value = parseFloat(activeKnob.dataset.value);
      
      // Update value based on drag distance (negative deltaY = increase value)
      value -= (deltaY * step);
      value = Math.max(min, Math.min(max, value));
      
      // Save the new value
      activeKnob.dataset.value = value;
      
      // Update rotation
      const angle = ((value - min) / range) * 270 - 135;
      activeKnob.style.transform = `rotate(${angle}deg)`;
      
      // Update synth parameters
      if (synthInitialized) {
        const knobId = activeKnob.id;
        
        switch (knobId) {
          case 'detune-knob':
            synth.set({ detune: value });
            break;
          case 'glide-knob':
            synth.set({ portamento: value });
            break;
          case 'reverb-knob':
            reverb.wet.value = value;
            break;
          case 'delay-knob':
            delay.wet.value = value;
            break;
        }
      }
    }
    
    // Computer keyboard mapping
    const keyMapping = {
      'a': 'C4', 's': 'D4', 'd': 'E4', 'f': 'F4',
      'g': 'G4', 'h': 'A4', 'j': 'B4', 'k': 'C5'
    };
    
    const pressedKeys = new Set();
    
    document.addEventListener('keydown', (e) => {
      if (!powerOn || !synthInitialized) return;
      
      const key = e.key.toLowerCase();
      if (keyMapping[key] && !pressedKeys.has(key)) {
        pressedKeys.add(key);
        const note = keyMapping[key];
        playNote(note);
        
        // Find and highlight the key
        const keyElement = document.querySelector(`.key[data-note="${note}"]`);
        if (keyElement) {
          keyElement.classList.add('active');
        }
      }
    });
    
    document.addEventListener('keyup', (e) => {
      if (!powerOn || !synthInitialized) return;
      
      const key = e.key.toLowerCase();
      if (keyMapping[key]) {
        pressedKeys.delete(key);
        const note = keyMapping[key];
        stopNote(note);
        
        // Remove highlight
        const keyElement = document.querySelector(`.key[data-note="${note}"]`);
        if (keyElement) {
          keyElement.classList.remove('active');
        }
      }
    });
    
    // Bird container click handler
    birbContainer.addEventListener('click', (e) => {
      if (!powerOn) return;
      
      const rect = birbContainer.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      createRipple(x, y);
      birbTargetX = x - 50;
      birbTargetY = y - 50;
      flapWings();
    });
    
    // Handle window resize
    window.addEventListener('resize', () => {
      if (powerOn) {
        // Keep the bird in view
        const maxX = birbContainer.clientWidth - 100;
        const maxY = birbContainer.clientHeight - 100;
        birbTargetX = Math.max(0, Math.min(maxX, birbTargetX));
        birbTargetY = Math.max(0, Math.min(maxY, birbTargetY));
      }
    });
    
    // Prevent scrolling on touch devices when interacting with the synth
    document.addEventListener('touchmove', (e) => {
      if (e.target.closest('.container')) {
        e.preventDefault();
      }
    }, { passive: false });
  </script>
</body>
</html>